# SynapseDTE Database Schema Analysis

## Overview
The SynapseDTE system uses PostgreSQL with SQLAlchemy ORM and Alembic for migrations. The database is designed to support a comprehensive 7-phase regulatory testing workflow with role-based access control (RBAC), audit trails, and multi-provider LLM integration.

## Database Models Summary

### 1. **Core User & Authentication Models**

#### User Model (`app/models/user.py`)
- **Primary Key**: `user_id` (Integer)
- **Key Fields**: 
  - `first_name`, `last_name`, `email` (unique), `phone`
  - `role` (enum): Tester, Test Executive, Report Owner, Report Owner Executive, Data Owner, Data Executive, Admin
  - `lob_id` (FK to LOB)
  - `hashed_password`
  - `is_active`
- **Key Relationships**: Multiple roles, permissions, owned reports, managed cycles, assignments

### 2. **RBAC Models** (`app/models/rbac.py`)

#### Permission Model
- **Primary Key**: `permission_id`
- **Key Fields**: `resource`, `action`, `description`
- **Unique Constraint**: `resource` + `action`

#### Role Model
- **Primary Key**: `role_id`
- **Key Fields**: `role_name` (unique), `description`, `is_system`, `is_active`
- **System Roles**: 7 pre-defined roles matching user roles

#### Supporting RBAC Tables
- `RolePermission`: Many-to-many between roles and permissions
- `UserRole`: Many-to-many between users and roles (with expiration support)
- `UserPermission`: Direct permissions for users (can override role permissions)
- `ResourcePermission`: Resource-level permissions (e.g., specific report access)
- `RoleHierarchy`: Role inheritance structure
- `PermissionAuditLog`: Tracks all permission changes

### 3. **Business Entity Models**

#### LOB (Line of Business) Model (`app/models/lob.py`)
- **Primary Key**: `lob_id`
- **Key Fields**: `lob_name` (unique)
- **Purpose**: Organization structure for reports and user assignments

#### Report Model (`app/models/report.py`)
- **Primary Key**: `report_id`
- **Key Fields**: 
  - `report_name`, `regulation`, `description`, `frequency`
  - `report_owner_id` (FK to User)
  - `lob_id` (FK to LOB)
  - `is_active`
- **Key Relationships**: Owner, LOB, cycle reports, documents, attributes

#### DataSource Model
- **Primary Key**: `data_source_id`
- **Key Fields**:
  - `data_source_name`, `database_type`, `database_url`
  - `database_user`, `database_password_encrypted` (AES-256 encrypted)
  - `is_active`
- **Security**: Implements AES-256 encryption for database passwords

### 4. **Workflow Management Models**

#### TestCycle Model (`app/models/test_cycle.py`)
- **Primary Key**: `cycle_id`
- **Key Fields**:
  - `cycle_name`, `description`
  - `test_manager_id` (FK to User)
  - `start_date`, `end_date`
  - `status`, `workflow_id` (for Temporal integration)
- **Key Relationships**: Test manager, cycle reports, workflow phases, documents

#### WorkflowPhase Model (`app/models/workflow.py`)
- **Primary Key**: `phase_id`
- **Key Fields**:
  - `cycle_id`, `report_id` (FKs)
  - `phase_name` (enum): Planning, Data Profiling, Scoping, Sample Selection, Data Provider ID, Request Info, Testing, Test Execution, Observations, Finalize Test Report
  - `state` (enum): Not Started, In Progress, Complete
  - `schedule_status` (enum): On Track, At Risk, Past Due
  - Override fields: `state_override`, `status_override`, `override_reason`
  - Date tracking: `planned_start_date`, `planned_end_date`, `actual_start_date`, `actual_end_date`
  - `phase_data` (JSONB): Stores phase-specific data

#### WorkflowActivity Model (`app/models/workflow_activity.py`)
- **Primary Key**: `activity_id`
- **Key Fields**:
  - `cycle_id`, `report_id`, `phase_name`
  - `activity_name`, `activity_type` (enum), `activity_order`
  - `status` (enum): NOT_STARTED, IN_PROGRESS, COMPLETED, REVISION_REQUESTED, BLOCKED, SKIPPED
  - Control flags: `can_start`, `can_complete`, `is_manual`, `is_optional`
- **Purpose**: Granular tracking of activities within each phase

### 5. **Phase-Specific Models**

#### Document Model
- Tracks uploaded documents with versioning
- Fields include mime type, file path, upload metadata

#### ReportAttribute Model
- Stores testing attributes generated by LLM
- Includes scoping decisions and metadata

#### ScopingSubmission Model
- Tracks scoping phase submissions with versioning
- Includes review status and comments

#### DataOwnerAssignment Model
- Manages data owner assignments per LOB
- Tracks assignment history and SLA violations

#### SampleSet Model
- Manages sample selections with versioning
- Supports individual sample tracking and approval workflows

#### TestExecution Model
- Records test execution results
- Supports both document and database testing

#### Observation Models (Enhanced)
- Tracks testing issues and findings
- Supports grouping, approval workflows, and auto-categorization

### 6. **Audit & Compliance Models**

#### AuditLog Model
- **Purpose**: System-wide operation logging
- **Fields**: user_id, action, resource_type, resource_id, timestamp, details

#### LLMAuditLog Model
- **Purpose**: Complete LLM request/response audit trail
- **Fields**: provider, model, prompt, response, tokens used, latency, error details

#### SLAConfiguration Model
- **Purpose**: Configurable SLA rules with escalation
- **Fields**: phase, duration_hours, warning_threshold, escalation_levels

### 7. **Supporting Models**

#### UniversalAssignment Model
- Generic assignment framework for any workflow task
- Supports delegation, escalation, and approval chains

#### Metrics Models
- `PhaseMetrics`: Tracks phase-level performance
- `ExecutionMetrics`: Tracks execution-level metrics

#### Versioning Models
- Multiple versioned models for tracking changes over time
- Includes: `DataProfilingRuleVersion`, `TestExecutionVersion`, `ObservationVersion`, etc.

## Key Database Design Patterns

### 1. **Enum Usage**
The system uses PostgreSQL ENUMs extensively:
- `user_role_enum`: 7 user roles
- `workflow_phase_enum`: 10 workflow phases
- `workflow_phase_state_enum`: Progress tracking states
- `workflow_phase_status_enum`: Schedule adherence statuses
- `mandatory_flag_enum`: Mandatory/Conditional/Optional
- `ActivityStatus`, `ActivityType`: For workflow activities

### 2. **Audit Trail Pattern**
- Most models include `created_at` and `updated_at` timestamps
- Separate audit log tables for system operations and LLM usage
- User tracking for all state changes

### 3. **Versioning Pattern**
- Multiple models support versioning (e.g., ScopingSubmission, SampleSet)
- Version history tables maintain change tracking
- Archive functionality for superseded versions

### 4. **Security Patterns**
- AES-256 encryption for sensitive data (database passwords)
- Role-based access control with resource-level permissions
- Comprehensive audit logging for compliance

### 5. **Relationship Patterns**
- Extensive use of foreign keys for referential integrity
- Many-to-many relationships through association tables
- Circular import prevention through late binding

## Critical Seed Data Requirements

### 1. **RBAC Seed Data** (from `002_seed_rbac_data.py`)

#### Roles (7 system roles)
1. Tester - Executes testing workflow
2. Test Executive - Manages test cycles
3. Data Owner - Provides source data
4. Data Executive - Manages data owner assignments
5. Report Owner - Approves testing decisions
6. Report Executive - Executive oversight
7. Admin - System administrator

#### Permissions (50+ defined)
- Test cycle management (create, read, update, delete)
- Report assignment permissions
- Phase-specific execution permissions
- Dashboard access permissions
- Admin permissions

#### Role-Permission Mappings
- Tester: 8 permissions
- Test Executive: 13 permissions (includes all tester permissions)
- Data Owner: 2 permissions
- Data Executive: 3 permissions
- Report Owner: 4 permissions
- Report Executive: 2 permissions
- Admin: All permissions

### 2. **Workflow Configuration**
- 8 workflow phases with dependencies
- SLA configurations for each phase
- Phase sequence and parallel execution rules

### 3. **System Configuration**
- Default SLA rules
- Escalation configurations
- Business hours definitions

## Migration History

The system has undergone several migrations:
1. **Initial Schema** - Base table creation
2. **Missing Indexes** - Performance optimization
3. **RBAC Seed Data** - Initial permission setup
4. **Unified Audit Log** - Consolidated audit trail
5. **Document Revision Tracking** - Version control
6. **Enhanced Observations** - Improved issue tracking
7. **Workflow Tracking** - Enhanced state management
8. **Data Profiling** - New phase support
9. **Individual Samples** - Granular sample tracking
10. **Universal Assignment Framework** - Generic task assignment

## Database Relationships Summary

### Key Relationship Patterns:
1. **User-centric**: Users connect to roles, permissions, reports, cycles, and assignments
2. **Cycle-centric**: Test cycles connect to reports, phases, documents, and executions
3. **Report-centric**: Reports connect to owners, LOBs, attributes, and test results
4. **Phase-centric**: Workflow phases connect to activities, submissions, and approvals

### Critical Foreign Key Relationships:
- User → LOB (many-to-one)
- Report → User (owner, many-to-one)
- Report → LOB (many-to-one)
- TestCycle → User (manager, many-to-one)
- WorkflowPhase → TestCycle, Report (composite key)
- WorkflowActivity → WorkflowPhase (composite foreign key)

## Performance Considerations

### Indexes:
- Primary keys on all tables
- Unique constraints on business keys
- Indexes on foreign keys
- Composite indexes for common query patterns
- Status field indexes for filtering

### JSONB Usage:
- `phase_data` in WorkflowPhase for flexible storage
- `metadata` fields in various models
- Efficient for semi-structured data

### Audit Trail Impact:
- Separate audit tables to avoid impacting operational performance
- Async logging patterns recommended
- Consider partitioning for large audit tables

## Security Considerations

1. **Encryption**: AES-256 for sensitive data (passwords, credentials)
2. **RBAC**: Fine-grained permission control at resource level
3. **Audit Trail**: Complete logging of all sensitive operations
4. **Data Isolation**: LOB-based data segregation
5. **Password Storage**: Bcrypt hashing for user passwords

## Recommendations for Database Management

1. **Regular Maintenance**:
   - Vacuum and analyze tables regularly
   - Monitor index usage and query performance
   - Archive old audit logs

2. **Backup Strategy**:
   - Daily backups with point-in-time recovery
   - Test restore procedures regularly
   - Separate backup of encryption keys

3. **Migration Best Practices**:
   - Always test migrations in staging
   - Maintain rollback scripts
   - Document all schema changes

4. **Monitoring**:
   - Query performance monitoring
   - Connection pool usage
   - Lock monitoring for concurrent access

5. **Scaling Considerations**:
   - Consider read replicas for reporting
   - Partition large tables (audit logs, LLM logs)
   - Implement connection pooling