# Common Mistakes to Avoid

## 1. Removing Activity/Workflow Cards from Sample Selection Page
**Mistake**: Removing the workflow visualization cards from SampleSelectionPage.tsx
**Impact**: User complains "Card Layout is gone again"
**Solution**: ALWAYS keep the workflow cards section that shows the 6 steps:
- Start Phase
- Generate/Upload Samples
- Review & Select
- Submit for Approval
- Report Owner Review
- Complete Phase

**Code to preserve**:
```tsx
{/* Phase Workflow Visual */}
<Card sx={{ mb: 3 }}>
    <CardContent>
        <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <TableViewIcon color="primary" />
            Sample Selection Phase Workflow
        </Typography>
        
        <Box sx={{ mt: 2 }}>
            <Box sx={{ display: 'flex', gap: 2, flexWrap: 'wrap' }}>
                {getSamplingSteps().map((step, index) => (
                    // Activity card implementation
                ))}
            </Box>
        </Box>
    </CardContent>
</Card>
```

## 2. WorkflowPhase Model Attribute Names
**Mistake**: Using `phase_status` instead of `status`
**Correct**: WorkflowPhase model uses `status` not `phase_status`
```python
# WRONG
phase.phase_status == "Pending Approval"

# CORRECT  
phase.status == "Pending Approval"
```

## 3. Breaking Working LLM Sample Generation
**Mistake**: Adding a generate_samples method to llm_service.py
**Impact**: Breaks the existing working sample generation that uses external prompts
**Solution**: Use direct LLM provider calls with external prompts from /prompts/regulatory/

## 4. Showing Sample Sets Instead of Individual Samples
**Mistake**: Using sample set UI components when user wants individual samples
**Solution**: Show samples in a table with these columns:
- Sample ID
- Primary Key Value
- Generation Method
- Generated At
- Generated By
- Tester Decision
- Report Owner Decision
- Actions

## 5. API Path Errors
**Mistake**: Using wrong API paths like `/sample-selection/{cycle_id}/reports/{report_id}`
**Correct**: Always use `/cycles/{cycle_id}/reports/{report_id}/sample-selection`

## 6. Frontend State Management
**Mistake**: Not calling loadPhaseStatus() in initial useEffect
**Impact**: Phase cards show wrong status
**Solution**: Always include loadPhaseStatus() in the initial data loading

## 7. Sample Individual vs Sample Selection
**Mistake**: Creating separate sample_individual module
**Decision**: User wants everything in sample_selection, no separate individual module

## 8. Database Model References
**Key Models**:
- WorkflowPhase: tracks phase status (uses `status` field)
- SampleRecord: individual sample storage
- User: uses `user_id` not `id`
- CycleReport: links cycles, reports, and users

## 9. Essential UI Elements to Preserve
1. Report header with LOB, Tester, Owner info
2. Workflow visualization cards
3. Report owner feedback alert (when applicable)
4. Start Phase button (when phase not started)
5. Generate/Upload/Refresh buttons
6. Bulk action buttons
7. Submit for Approval button

## 10. Testing Phase Patterns
**Start Phase**: Must check if phase exists and status is "Not Started"
**Complete Phase**: Must verify samples are approved by report owner
**Phase Status Values**: "Not Started", "In Progress", "Pending Approval", "Complete"

## 11. User Model Column Names
**Mistake**: Using `u.name` in SQL queries
**Correct**: User model has `first_name` and `last_name`, not `name`
```sql
-- WRONG
SELECT u.name as generated_by_name

-- CORRECT
SELECT CONCAT(u.first_name, ' ', u.last_name) as generated_by_name
```

## 12. Browser Cache Issues
**Problem**: Browser caches old JavaScript bundles showing wrong API endpoints
**Solution**: User needs to hard refresh (Cmd+Shift+R on Mac) or clear browser cache
**Example**: Seeing calls to `/sample-individual/` when code uses `/sample-selection/`

## 13. LLMAuditLog Model Fields
**Mistake**: Using wrong field names when creating LLMAuditLog
**Correct fields**:
- cycle_id, report_id
- llm_provider (not provider)
- prompt_template (file path)
- request_payload (JSONB)
- response_payload (JSONB)
- execution_time_ms
- token_usage (JSONB)
- executed_at
- executed_by (user_id)

## 14. Dynamic Prompt Selection
**Requirement**: Select prompt based on report's regulation field
**Implementation**: 
- Get report.regulation from database
- Convert to file path format (e.g., "FR Y-14M Schedule D.1" -> "fr_y_14m/schedule_d_1")
- Check if specific prompt exists at prompts/regulatory/{path}/sample_generation.txt
- Fallback to FR Y-14M Schedule D.1 if not found
- Log which prompt is being used