# Database Setup Solution for Containerized Testing

This document explains how the database setup works for containerized testing, addressing the broken migration issue comprehensively.

## Key Issues Addressed

### 1. **Broken Migrations**
The Alembic migrations are broken, so we cannot rely on them for containerized database initialization.

### 2. **Complete Schema Requirements**
The schema must include:
- All SQLAlchemy model fields including mixins (TimestampMixin, AuditMixin)
- Correct primary key names (e.g., `user_id` not `id` for User model)
- All required relationships and foreign keys
- Proper indexes for performance

### 3. **Essential Seed Data**
The system requires:
- RBAC roles and permissions for authorization to work
- Test users with proper password hashes
- Role assignments for test users
- Core lookup data (LOBs, etc.)

## Solution Components

### 1. **Complete Schema SQL (`01-complete-schema.sql`)**

This file was generated by analyzing:
- `app/models/base.py` - Base models and mixins
- `app/models/audit_mixin.py` - Audit tracking fields
- `app/models/user.py` - User model with custom primary key
- `app/models/rbac.py` - Complete RBAC table structure
- Other model files for table relationships

Key features:
```sql
-- Mixins are properly included
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,  -- Not 'id' - matches User model
    -- ... fields ...
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL,  -- TimestampMixin
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP NOT NULL   -- TimestampMixin
);

-- AuditMixin fields on appropriate tables
CREATE TABLE lobs (
    -- ... fields ...
    created_by_id INTEGER REFERENCES users(user_id) ON DELETE SET NULL,  -- AuditMixin
    updated_by_id INTEGER REFERENCES users(user_id) ON DELETE SET NULL   -- AuditMixin
);
```

### 2. **Migration Bypass Script (`bypass_migrations.py`)**

Python script that:
- Checks if database is already initialized
- Skips migrations if tables exist
- Sets DOCKER_CONTAINER environment variable for detection
- Inserts alembic_version to prevent migration attempts

### 3. **Test Database Setup Script (`test_db_setup.sh`)**

Robust bash script with multiple fallback strategies:
1. First checks if database is initialized
2. Tries to apply SQL schema file
3. Falls back to migrations if needed
4. Creates minimal schema as last resort

### 4. **Docker Integration**

#### Updated Backend Dockerfile:
```dockerfile
# Copy migration bypass script
COPY --chown=appuser:appuser ./scripts/docker/bypass_migrations.py ./scripts/docker/

# Modified startup script
export DOCKER_CONTAINER=1
if [ -f /app/scripts/docker/bypass_migrations.py ]; then
    python /app/scripts/docker/bypass_migrations.py
else
    alembic upgrade head || echo "Migration failed, but continuing..."
fi
```

#### Docker Compose Volume Mounts:
```yaml
postgres:
  volumes:
    - ./scripts/db/init:/docker-entrypoint-initdb.d:ro
```

PostgreSQL automatically executes SQL files in `/docker-entrypoint-initdb.d/` on first startup.

## How It Works

### First Container Start:

1. PostgreSQL starts and creates empty database
2. Executes `01-complete-schema.sql` from init directory
3. Creates all tables with proper structure
4. Inserts essential seed data (RBAC, users, etc.)
5. Backend starts and detects initialized database
6. Skips migrations via bypass script

### Subsequent Starts:

1. Database already has data
2. PostgreSQL skips initialization
3. Backend detects existing schema
4. Application runs normally

## Essential Seed Data Included

### RBAC System:
- 7 system roles (Administrator, Test Executive, Tester, etc.)
- Core permissions for all resources
- Administrator gets all permissions
- Proper role-permission assignments

### Test Users:
All with password 'password123':
- `admin@test.local` - Admin role
- `test.executive@test.local` - Test Executive role  
- `tester@test.local` - Tester role
- `report.owner@test.local` - Report Owner role
- `data.owner@test.local` - Data Owner role

### Other Data:
- 3 test LOBs (Corporate, Retail, Investment Banking)
- Alembic version marker to prevent migration attempts
- Proper sequence resets for all tables

## Verification

To verify the setup:

```bash
# Check tables exist
docker-compose exec postgres psql -U synapse_user -d synapse_dt -c "\dt"

# Check user data
docker-compose exec postgres psql -U synapse_user -d synapse_dt -c "SELECT email, role FROM users;"

# Check RBAC setup
docker-compose exec postgres psql -U synapse_user -d synapse_dt -c "SELECT role_name FROM rbac_roles;"

# Test login with seeded user
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin@test.local&password=password123"
```

## Advantages of This Approach

1. **Deterministic** - Same schema every time
2. **Fast** - No migration overhead
3. **Complete** - All mixins and relationships included
4. **Self-contained** - No external dependencies
5. **Testable** - Known test data available immediately

## Maintenance

When models change:
1. Update the schema SQL file
2. Increment the version in alembic_version insert
3. Test thoroughly before deployment

For production:
1. Use proper migrations once fixed
2. This solution is specifically for containerized testing
3. Can export production schema as needed

## Troubleshooting

### "Table already exists" errors
- Database wasn't properly cleaned between tests
- Run: `docker-compose down -v` to remove volumes

### "Permission denied" errors  
- Check that GRANT statements executed
- Verify synapse_user has proper permissions

### Missing RBAC data
- Full RBAC seeding requires running seed script
- Basic permissions included for testing
- Run: `python scripts/utils/seed_rbac_permissions.py`

### Authentication failures
- Verify password hash is correct (bcrypt, 12 rounds)
- Check user role matches RBAC role name
- Ensure rbac_user_roles record exists